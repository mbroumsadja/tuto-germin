<!DOCTYPE html>
  <html lang="fr">
  <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Kanban - tuto-germin</title>
    
     <link rel="stylesheet" href="/public/css/style.css">
  <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color:rgba(6, 54, 32, 0.863);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            margin: 20px 0;
            font-size: 2.5em;
        }
        .task-form {
            text-align: center;
            margin-bottom: 20px;
        }
        .task-form input, .task-form select, .task-form button {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .task-form button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .task-form button:hover {
            background-color: #45a049;
        }
        .task-form .reset-btn {
            background-color: #f44336;
        }
        .task-form .reset-btn:hover {
            background-color: #da190b;
        }
        .kanban-board {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            flex: 1;
        }
        .column {
            background-color: #e0e0e0;
            border-radius: 20px;
            width: 30%;
            padding: 10px;
            min-height: 300px;
        }
        .column h2 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #333;
        }
        .task {
            background-color: #2e2e2e;
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: move;
            border: 1px solid #444;
            position: relative;
            transition: transform 0.2s;
        }
        .task.dragging {
            opacity: 0.5;
            transform: scale(1);
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
        }
        .delete-btn:hover {
            color: #ff0000;
        }
        .label {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            color: white;
            margin-bottom: 5px;
        }
        .label.urgent {
            background-color: #e74c3c;
        }
        .label.normal {
            background-color: #3498db;
        }
        .task h3 {
            margin: 5px 0;
            font-size: 1em;
            padding: 5px;
            border-radius:5px ;
            background-color: #ddd;
            color:black;
        }
        .task p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #ccc;
        }
        .timer-container {
            text-align: center;
            margin: 10px 0;
        }
        .timer-container span {
            font-size: 1.2em;
            margin-right: 10px;
        }
        .timer-container button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .timer-container .start-btn {
            background-color: #4CAF50;
            color: white;
        }
        .timer-container .start-btn:hover {
            background-color: #45a049;
        }
        .timer-container .stop-btn {
            background-color: #f0ad4e;
            color: white;
        }
        .timer-container .stop-btn:hover {
            background-color: #ec971f;
        }
        .timer-container .reset-btn {
            background-color: #f44336;
            color: white;
        }
        .timer-container .reset-btn:hover {
            background-color: #da190b;
        }
        footer {
            background-color: #ddd;
            display:flex;
            justify-content:center;
            align-items: center;
            width:100%;
            height:3vh;
        }
        @media (max-width: 768px) {
            .kanban-board {
                flex-direction: column;
                align-items: center;
            }
            .column {
                width: 90%;
                margin-bottom: 20px;
            }
        }
          #timer{
          font-size: 30px;
          font-weight:bold;
          color: rgb(221, 221, 221);
        }
    </style>
  </head>
  <body>
     <div class="timer-container">
        <span id="timer">00:00:00</span>
        <button class="start-btn" onclick="startTimer()">Démarrer</button>
        <button class="stop-btn" onclick="stopTimer()">Arrêter</button>
        <button class="reset-btn" onclick="resetTimer()">Réinitialiser</button>
     </div>
     <div class="task-form">
        <input type="text" id="task-title" placeholder="Titre de la tâche" required>
        <input type="text" id="task-desc" placeholder="Description" required>
        <select id="task-label">
          <option value="urgent">Urgent</option>
          <option value="normal">Normal</option>
        </select>
        <button onclick="addTask()">Ajouter une tâche</button>
        <input type="file" id="json-upload" accept=".json" onchange="uploadTasks()">
        <button class="reset-btn" onclick="resetTasks()">Réinitialiser</button>
     </div>
     <div class="kanban-board">
        <div class="column" id="todo" ondragover="allowDrop(event)" ondrop="drop(event, 'todo')">
          <h2>À faire</h2>
        </div>
        <div class="column" id="in-progress" ondragover="allowDrop(event)" ondrop="drop(event, 'in-progress')">
          <h2>En cours</h2>
        </div>
        <div class="column" id="done" ondragover="allowDrop(event)" ondrop="drop(event, 'done')">
          <h2>Terminé</h2>
        </div>
     </div>
     <footer>
        <p>© 2025 tuto-germin</p>
     </footer>
     <script>
        // Utiliser une clé unique pour chaque projet dans le cache
        const PROJECT_KEY = "kanbanTasks_tuto_germin";
        const TIMER_KEY = "projectTimer_tuto_germin";

        // Charger les tâches depuis localStorage pour ce projet
        let tasks = JSON.parse(localStorage.getItem(PROJECT_KEY)) || {
          "todo": [],
          "in-progress": [],
          "done": []
        };

        // Initialiser le chronomètre
        let timer = JSON.parse(localStorage.getItem(TIMER_KEY)) || 0;
        let timerInterval = null;
        const timerDisplay = document.getElementById("timer");

        function formatTime(seconds) {
          const hrs = Math.floor(seconds / 3600).toString().padStart(2, "0");
          const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, "0");
          const secs = (seconds % 60).toString().padStart(2, "0");
          return `${hrs}:${mins}:${secs}`;
        }

        function updateTimer() {
          timer++;
          timerDisplay.textContent = `${formatTime(timer)}`;
          localStorage.setItem(TIMER_KEY, JSON.stringify(timer));
        }

        function startTimer() {
          if (!timerInterval) {
             timerInterval = setInterval(updateTimer, 1000);
          }
        }

        function stopTimer() {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        function resetTimer() {
          stopTimer();
          timer = 0;
          timerDisplay.textContent = `${formatTime(timer)}`;
          localStorage.setItem(TIMER_KEY, JSON.stringify(timer));
        }

        // Charger les tâches
        function loadTasks() {
          ["todo", "in-progress", "done"].forEach(columnId => {
             const column = document.getElementById(columnId);
             column.innerHTML = `<h2>${columnId === "todo" ? "À faire" : columnId === "in-progress" ? "En cours" : "Terminé"}</h2>`;
             tasks[columnId].forEach(task => {
                const taskElement = createTaskElement(task);
                column.appendChild(taskElement);
             });
          });
          timerDisplay.textContent = `${formatTime(timer)}`;
        }

        function createTaskElement(task) {
          const taskElement = document.createElement("div");
          taskElement.className = "task";
          taskElement.setAttribute("draggable", "true");
          taskElement.setAttribute("data-id", task.id);
          taskElement.innerHTML = `
             <div class="label ${task.label}">${task.label.charAt(0).toUpperCase() + task.label.slice(1)}</div>
             <h3>${task.title}</h3>
             <p>${task.description}</p>
             <button class="delete-btn" onclick="deleteTask(this, '${task.id}')">×</button>
          `;
          taskElement.addEventListener("dragstart", drag);
          return taskElement;
        }

        function saveTasks() {
          tasks = {
             "todo": [],
             "in-progress": [],
             "done": []
          };
          ["todo", "in-progress", "done"].forEach(columnId => {
             const column = document.getElementById(columnId);
             const taskElements = column.querySelectorAll(".task");
             taskElements.forEach(taskElement => {
                const label = taskElement.querySelector(".label").textContent.toLowerCase();
                const title = taskElement.querySelector("h3").textContent;
                const description = taskElement.querySelector("p").textContent;
                const id = taskElement.getAttribute("data-id");
                tasks[columnId].push({ id, title, description, label });
             });
          });
          localStorage.setItem(PROJECT_KEY, JSON.stringify(tasks));
        }

        function deleteTask(button, taskId) {
          if (confirm("Êtes-vous sûr de vouloir supprimer cette tâche ?")) {
             button.parentElement.remove();
             ["todo", "in-progress", "done"].forEach(columnId => {
                tasks[columnId] = tasks[columnId].filter(task => task.id !== taskId);
             });
             saveTasks();
          }
        }

        function resetTasks() {
          if (confirm("Êtes-vous sûr de vouloir réinitialiser toutes les tâches ? Cette action est irréversible.")) {
             localStorage.removeItem(PROJECT_KEY);
             tasks = { "todo": [], "in-progress": [], "done": [] };
             loadTasks();
          }
        }

        function drag(event) {
          event.dataTransfer.setData("text/plain", event.target.getAttribute("data-id"));
          event.target.classList.add("dragging");
          setTimeout(() => {
             event.target.style.display = "none";
          }, 0);
        }

        function allowDrop(event) {
          event.preventDefault();
        }

        function drop(event, columnId) {
          event.preventDefault();
          const taskId = event.dataTransfer.getData("text/plain");
          const draggedElement = document.querySelector(`.task[data-id="${taskId}"]`);
          if (draggedElement && event.target.classList.contains("column")) {
             draggedElement.style.display = "";
             draggedElement.classList.remove("dragging");
             event.target.appendChild(draggedElement);
             saveTasks();
          }
        }

        function addTask() {
          const title = document.getElementById("task-title").value.trim();
          const desc = document.getElementById("task-desc").value.trim();
          const label = document.getElementById("task-label").value;

          if (!title || !desc) {
             alert("Veuillez remplir tous les champs !");
             return;
          }

          // Vérifier l'unicité de la tâche (titre + description)
          const isDuplicate = Object.values(tasks).some(column =>
             column.some(task => task.title === title && task.description === desc)
          );
          if (isDuplicate) {
             alert("Une tâche avec ce titre et cette description existe déjà !");
             return;
          }

          const taskId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
          const task = { id: taskId, title, description: desc, label };
          tasks["todo"].push(task);
          const taskElement = createTaskElement(task);
          document.getElementById("todo").appendChild(taskElement);
          saveTasks();
          document.getElementById("task-title").value = "";
          document.getElementById("task-desc").value = "";
        }

        function uploadTasks() {
          const fileInput = document.getElementById("json-upload");
          const file = fileInput.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function(event) {
             try {
                const uploadedTasks = JSON.parse(event.target.result);
                if (!Array.isArray(uploadedTasks)) {
                  alert("Le fichier JSON doit contenir un tableau de tâches !");
                  return;
                }
                let added = 0;
                uploadedTasks.forEach(task => {
                  if (!task.title || !task.description || !task.label) {
                     return;
                  }
                  // Vérifier l'unicité de la tâche (titre + description)
                  const isDuplicate = Object.values(tasks).some(column =>
                     column.some(t => t.title === task.title && t.description === task.description)
                  );
                  if (!isDuplicate) {
                     const taskId = (Date.now() + Math.random()).toString();
                     const newTask = { id: taskId, title: task.title, description: task.description, label: task.label };
                     tasks["todo"].push(newTask);
                     const taskElement = createTaskElement(newTask);
                     document.getElementById("todo").appendChild(taskElement);
                     added++;
                  }
                });
                saveTasks();
                if (added === 0) {
                  alert("Aucune nouvelle tâche ajoutée (toutes étaient déjà présentes ou invalides).");
                }
             } catch (e) {
                alert("Erreur lors de la lecture du fichier JSON : format invalide !");
             }
          };
          reader.readAsText(file);
          fileInput.value = "";
        }

        window.onload = loadTasks;
     </script>
  </body>
  </html>